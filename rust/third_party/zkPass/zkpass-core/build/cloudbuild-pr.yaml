steps: 
  - id: Download Key from S3
    name: amazon/aws-cli:2.15.15
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        set -e
        aws s3 cp --region ${_AWS_BUCKET_REGION} s3://${_AWS_BUCKET_NAME}/ . --recursive
    env:
      - 'HOME=/root'
    secretEnv:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY

  - id: Build
    name: gcr.io/cloud-builders/docker
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        git config --global --add safe.directory /workspace
        chown -R 1000:1000 .
        docker compose -f build/docker-compose-gcb.yml run --rm ${_MODULE}
    env:
      - 'ENV=${_ENV}'
  
  - id: Build Host Image
    name: gcr.io/cloud-builders/docker
    args:
      - 'build'
      - '-t'
      - '${_REGISTRY_URL}/${_PROJECT}/host:${SHORT_SHA}'
      - '--cache-from'
      - '${_REGISTRY_URL}/${_PROJECT}/host:${SHORT_SHA}'
      - '--build-arg' 
      - 'BUILDKIT_INLINE_CACHE=1'
      - '-f'
      - 'Dockerfile.host'
      - '.'
    waitFor: 
      - 'Build'

  - id: Build WS Image
    name: gcr.io/cloud-builders/docker
    args:
      - 'build'
      - '-t'
      - '${_REGISTRY_URL}/${_PROJECT}/ws:${SHORT_SHA}'
      - '--cache-from'
      - '${_REGISTRY_URL}/${_PROJECT}/ws:${SHORT_SHA}'
      - '--build-arg' 
      - 'BUILDKIT_INLINE_CACHE=1'
      - '-f'
      - 'Dockerfile.ws'
      - '.'
    waitFor: 
      - 'Build'
        
  - id: List Images  
    name: 'gcr.io/cloud-builders/docker'
    entrypoint: bash
    args:
    - '-c'
    - |
      docker images "${_REGISTRY_URL}/zkpass/*" --format "{{.Repository}}:{{.Tag}}" > list-docker-images.txt

  - id: Image scan  
    name: 'asia.gcr.io/glair01/gl-base/trivyscan'
    entrypoint: bash
    args:
    - '-c'
    - |
      while IFS= read -r line;
      do
        filename=$(echo $line | tr '/' '-')
          touch $filename.image.txt
          trivyscan $line $filename.image.txt
      done < list-docker-images.txt

  - id: Scan result to Github Issue
    name: 'asia.gcr.io/glair01/gl-base/github'
    entrypoint: 'bash'
    args:
      - '-c'
      - |-
      
        for image in *.image.txt; do
          export TITLE=$(echo "${image%.*.*}")
          /root/comment-pr-trivy.sh $$image
        done
    env:
      - 'REPOSITORY=${_GITHUB_USER}/${REPO_NAME}'
    secretEnv: 
      - 'GH_TOKEN'

  - id: Check Trivy Result
    name: asia.gcr.io/glair01/gl-base/trivyscan
    entrypoint: bash
    args:
      - '-c'
      - |-
      
        for image in *.image.txt; do
          /root/check.sh $$image
        done

  - id: Remove Key
    name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - '-c'
      - |
        rm -f key-pairs.json public-keys.json

availableSecrets:
  secretManager:
  - versionName: projects/$PROJECT_ID/secrets/INFRA_GL_GITHUB_TOKEN/versions/latest
    env: 'GH_TOKEN'
  - versionName: projects/$PROJECT_ID/secrets/SWISS_STAGING_AWS_ACCESS_KEY_ID/versions/latest
    env: 'AWS_ACCESS_KEY_ID'
  - versionName: projects/$PROJECT_ID/secrets/SWISS_STAGING_AWS_SECRET_ACCESS_KEY/versions/latest
    env: 'AWS_SECRET_ACCESS_KEY'
      
substitutions:
  _REGISTRY_URL: asia.gcr.io/gdp-labs
  _PROJECT: zkpass
  _GITHUB_USER: GDP-ADMIN

options:
  machineType: E2_HIGHCPU_32
  env:
    - 'DOCKER_BUILDKIT=1'
    - 'COMPOSE_DOCKER_CLI_BUILD=1'

timeout: 60m

tags: ["swiss"]
