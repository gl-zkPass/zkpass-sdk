steps:
  - id: Decrypt env
    name: gcr.io/cloud-builders/gcloud
    dir: ${_PROJECT}-${_MODULE}
    args:
      - kms
      - decrypt
      - --ciphertext-file=dev-zkpass.env.enc
      - --plaintext-file=zkpass.env
      - --location=global
      - --keyring=cloudbuild
      - --key=zkpass
    waitFor: ['-']

  - id: Build
    name: gcr.io/cloud-builders/docker
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        chown -R 1000:1000 .
        docker compose -f build/docker-compose-gcb.yml run --rm ${_PROJECT}-${_MODULE}
    env:
      - 'SHORT_SHA=${SHORT_SHA}'
      - 'WORKDIR=${_PROJECT}-${_MODULE}'

  - id: Dockerfile Linter
    name: 'hadolint/hadolint:v2.9.3-alpine'
    dir: ${_PROJECT}-${_MODULE}
    entrypoint: hadolint
    args: ['--failure-threshold', 'style', 'Dockerfile']
    waitFor: ['-']

  - id: Build Image
    name: gcr.io/cloud-builders/docker
    dir: ${_PROJECT}-${_MODULE}
    args:
      - 'build'
      - '-t'
      - '${_REGISTRY_URL}/${_PROJECT}/${_MODULE}:${SHORT_SHA}'
      - '-t'
      - '${_REGISTRY_URL}/${_PROJECT}/${_MODULE}:latest'
      - '--cache-from'
      - '${_REGISTRY_URL}/${_PROJECT}/${_MODULE}:latest'
      - '--build-arg' 
      - 'BUILDKIT_INLINE_CACHE=1'
      - '-f'
      - 'Dockerfile'
      - '.'
    waitFor: 
      - 'Build'
  
  - id: Trivy Scanning
    name: asia.gcr.io/glair01/gl-base/trivyscan
    entrypoint: bash
    args: ['trivyscan', '${_REGISTRY_URL}/${_PROJECT}/${_MODULE}:${SHORT_SHA}', 'scan-result.txt' ]
    waitFor:
      - 'Build Image'

  - id: Show Scan Result to Pull Request comment
    name: asia.gcr.io/glair01/gl-base/github
    entrypoint: /root/comment-pr-trivy.sh
    args:
      - 'scan-result.txt'
    env:
      - 'REPOSITORY=${_GITHUB_USER}/${REPO_NAME}'
      - 'COMMIT_ID=${REVISION_ID}'
      - 'TITLE=Trivy Result: ${_REGISTRY_URL}/${_PROJECT}/${_MODULE}:${SHORT_SHA}'
    secretEnv:
      - 'GH_TOKEN'

  - id: Check Trivy Result
    name: asia.gcr.io/glair01/gl-base/trivyscan
    entrypoint: /root/check.sh
    args: ['scan-result.txt']

timeout: 60m
substitutions:
  _PROJECT: zkpass
  _REGISTRY_URL: asia.gcr.io/gdp-labs
  _GITHUB_USER: GDP-ADMIN

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/INFRA_GL_GITHUB_TOKEN/versions/latest
      env: 'GH_TOKEN'

