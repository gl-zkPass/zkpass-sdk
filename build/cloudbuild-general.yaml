steps:
  - id: Decrypt env
    name: gcr.io/cloud-builders/gcloud
    dir: ${_PROJECT}-${_MODULE}
    args:
      - kms
      - decrypt
      - --ciphertext-file=${_ENV}-zkpass.env.enc
      - --plaintext-file=zkpass.env
      - --location=global
      - --keyring=cloudbuild
      - --key=zkpass

  - id: Build
    name: gcr.io/cloud-builders/docker
    args:
      - compose
      - -f
      - build/docker-compose-gcb.yml
      - run
      - --rm
      - ${_PROJECT}-${_MODULE}
    env:
      - 'WORKDIR=${_PROJECT}-${_MODULE}'
      - 'SHORT_SHA=${SHORT_SHA}'
      - 'ENV=${_ENV}'

  - id: Build Image
    name: gcr.io/cloud-builders/docker
    dir: ${_PROJECT}-${_MODULE}
    args:
      - 'build'
      - '-t'
      - '${_REGISTRY_URL}/${_PROJECT}/${_MODULE}:${SHORT_SHA}'
      - '-t'
      - '${_REGISTRY_URL}/${_PROJECT}/${_MODULE}:latest'
      - '--cache-from'
      - '${_REGISTRY_URL}/${_PROJECT}/${_MODULE}:latest'
      - '--build-arg' 
      - 'BUILDKIT_INLINE_CACHE=1'
      - '-f'
      - 'Dockerfile'
      - '.'
    waitFor: 
      - 'Build'

  - id: Push Container Image
    name: gcr.io/cloud-builders/docker
    args: 
      - 'push'
      - '-a'
      - '${_REGISTRY_URL}/${_PROJECT}/${_MODULE}'

  - id: Upload env var & artifact
    name: amazon/aws-cli:2.15.15
    dir: ${_PROJECT}-${_MODULE}
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        set -e
        aws s3 cp --region ${_AWS_BUCKET_REGION} zkpass.env s3://${_AWS_BUCKET_NAME}/${_MODULE}/
        aws s3 cp --region ${_AWS_BUCKET_REGION} docker-compose.yml s3://${_AWS_BUCKET_NAME}/${_MODULE}/
    env:
      - 'HOME=/root'
    secretEnv:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY

  - id: Deployment
    name: us.gcr.io/glair01/deployer:vision
    entrypoint: 'bash'
    dir: build
    args: 
      - '-c'
      - |
        set -e
        /bin/bash deploy.sh ${_AWS_ASG_NAME}
    env:
      - 'HOME=/root'
      - 'AWS_DEFAULT_REGION=${_AWS_ASG_REGION}'
    secretEnv:
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY

timeout: 30m
substitutions:
  _PROJECT: zkpass
  _REGISTRY_URL: asia.gcr.io/gdp-labs

options:
  machineType: E2_HIGHCPU_8

availableSecrets:
  secretManager:
    - versionName: projects/$PROJECT_ID/secrets/SWISS_STAGING_AWS_ACCESS_KEY_ID/versions/latest
      env: 'AWS_ACCESS_KEY_ID'
    - versionName: projects/$PROJECT_ID/secrets/SWISS_STAGING_AWS_SECRET_ACCESS_KEY/versions/latest
      env: 'AWS_SECRET_ACCESS_KEY'

tags: ["swiss"]
